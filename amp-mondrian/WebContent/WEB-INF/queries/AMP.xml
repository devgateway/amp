<?xml version="1.0"?>
<!DOCTYPE Schema PUBLIC "//UNKNOWN/" "mondrian.dtd">
<Schema name="AMP">
	<Cube name="Donor Funding">
		<Table name="v_donor_funding" />
		<Dimension name="Activity" foreignKey="amp_activity_id">
			<Hierarchy hasAll="true" primaryKey="amp_activity_id"
				primaryKeyTable="amp_activity" allMemberName="All Activities"
			>
				<Table name="amp_activity" />
				<Level name="Activity Title" column="name"
					table="amp_activity" uniqueMembers="true"
				/>
				<Level name="AMP ID" column="amp_id"
					table="amp_activity" uniqueMembers="true"
				/>
			</Hierarchy>
		</Dimension>
		<Dimension name="Donor">
			<Hierarchy hasAll="true" allLevelName="All Donors">
				<!-- No table element here. Fact table is assumed. -->
				<Level name="DonorType" column="donor_type_name" />
				<Level name="DonorGroup" column="org_grp_name" />
				<Level name="DonorName" column="donor_name" />
			</Hierarchy>
		</Dimension>
		<Dimension name="Financing Instrument">
			<Hierarchy hasAll="true"
				allLevelName="All Financing Instruments"
			>
				<!-- No table element here. Fact table is assumed. -->
				<Level name="Financing Instrument"
					column="financing_instrument_name"
				/>
			</Hierarchy>
		</Dimension>
		<Dimension name="Terms of Assistance">
			<Hierarchy hasAll="true"
				allLevelName="All Terms of Assistance"
			>
				<!-- No table element here. Fact table is assumed. -->
				<Level name="Terms of Assistance"
					column="terms_assist_name"
				/>
			</Hierarchy>
		</Dimension>
		<Dimension name="Time" type="TimeDimension"
			foreignKey="amp_fund_detail_id"
		>
			<Hierarchy hasAll="true" allMemberName="All Periods"
				primaryKey="amp_fund_detail_id"
			>
				<Table name="v_donor_date_hierarchy" />
				<Level name="Year" column="year" levelType="TimeYears"
					type="Numeric"
				/>
				<Level name="Quarter" column="quarter"
					ordinalColumn="quarter" nameColumn="quarter_name"
					levelType="TimeQuarters" type="Numeric"
				/>
				<Level name="Month" column="month" uniqueMembers="false"
					ordinalColumn="month" nameColumn="month_name"
					levelType="TimeMonths" type="Numeric"
				/>
			</Hierarchy>
		</Dimension>
		
		<Dimension name="Primary Sector" foreignKey="amp_activity_id">
			<Hierarchy hasAll="true" primaryKey="amp_activity_id" allMemberName="All Primary Sectors">
				<Table name="v_sectors"/>
				<Level name="Primary Sector" column="sectorname">
					<Property name="percentage" column="sector_percentage" type="Numeric"/>
				</Level>
			</Hierarchy>
		</Dimension>	
			
	
		<Dimension name="SectorAll" foreignKey="amp_activity_id">
			<Hierarchy hasAll="true" primaryKey="amp_activity_id"
				primaryKeyTable="amp_activity_sector" allMemberName="All Sectors"
			>
				<Join rightKey="amp_sector_id"
					leftKey="amp_sector_id"
				>
					<Table name="amp_activity_sector" />
					<Table name="amp_sector" />
				</Join>
				<Level name="Sector Name" table="amp_sector"
					column="name"
				/>
			</Hierarchy>
		</Dimension>
		<Measure name="Actual Commitments"
			aggregator="sum">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when v_donor_funding.transaction_type=1 and v_donor_funding.adjustment_type=1 then v_donor_funding.transaction_amount/getExchangeWithFixed(v_donor_funding.currency_code,v_donor_funding.transaction_date,v_donor_funding.fixed_exchange_rate) else 0 end 
				</SQL>
			</MeasureExpression>
		</Measure>
		
		<Measure name="Actual Disbursements"
			aggregator="sum">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when v_donor_funding.transaction_type=2 and v_donor_funding.adjustment_type=1 then v_donor_funding.transaction_amount/getExchangeWithFixed(v_donor_funding.currency_code,v_donor_funding.transaction_date,v_donor_funding.fixed_exchange_rate) else 0 end 
				</SQL>
			</MeasureExpression>
		</Measure>
		
		<Measure name="Activity Count" aggregator="distinct-count" column="amp_activity_id"/>
	
		
		<Measure name="Actual Expenditures"
			aggregator="sum">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when v_donor_funding.transaction_type=3 and v_donor_funding.adjustment_type=1 then v_donor_funding.transaction_amount/getExchangeWithFixed(v_donor_funding.currency_code,v_donor_funding.transaction_date,v_donor_funding.fixed_exchange_rate) else 0 end 
				</SQL>
			</MeasureExpression>
		</Measure>
		
		
		<Measure name="Planned Commitments"
			aggregator="sum">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when v_donor_funding.transaction_type=1 and v_donor_funding.adjustment_type=0 then v_donor_funding.transaction_amount/getExchangeWithFixed(v_donor_funding.currency_code,v_donor_funding.transaction_date,v_donor_funding.fixed_exchange_rate) else 0 end 
				</SQL>
			</MeasureExpression>
		</Measure>
		
		<Measure name="Planned Disbursements"
			aggregator="sum">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when v_donor_funding.transaction_type=2 and v_donor_funding.adjustment_type=0 then v_donor_funding.transaction_amount/getExchangeWithFixed(v_donor_funding.currency_code,v_donor_funding.transaction_date,v_donor_funding.fixed_exchange_rate) else 0 end 
				</SQL>
			</MeasureExpression>
		</Measure>
		
		<Measure name="Planned Expenditures"
			aggregator="sum">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when v_donor_funding.transaction_type=3 and v_donor_funding.adjustment_type=0 then v_donor_funding.transaction_amount/getExchangeWithFixed(v_donor_funding.currency_code,v_donor_funding.transaction_date,v_donor_funding.fixed_exchange_rate) else 0 end 
				</SQL>
			</MeasureExpression>
		</Measure>
		
		<CalculatedMember name="Sector Percentage" dimension="Measures">
  			<Formula>[Primary Sector].CurrentMember.Properties("percentage")</Formula>
		</CalculatedMember>
		
		
	</Cube>
	<!-- 
		<Cube name="Activities">
		<Table name="amp_activity" />
		<Dimension name="Activity">
		<Hierarchy hasAll="true" allMemberName="All Activities">
		<Level name="Title" column="name" uniqueMembers="true" />
		<Level name="ampId" column="amp_id"
		uniqueMembers="true"
		/>
		</Hierarchy>
		</Dimension>
		<Dimension name="Sector" foreignKey="amp_activity_id">
		<Hierarchy hasAll="true" primaryKey="amp_activity_id"
		primaryKeyTable="amp_activity_sector" allMemberName="All Sectors"
		>
		<Join rightKey="amp_sector_id"
		leftKey="amp_sector_id"
		>
		<Table name="amp_activity_sector" />
		<Table name="amp_sector" />
		</Join>
		<Level name="Sector Name" table="amp_sector"
		column="name"
		/>
		</Hierarchy>
		</Dimension>
		<Measure name="Draft" column="draft" aggregator="sum" />
		</Cube>
	-->
</Schema>
