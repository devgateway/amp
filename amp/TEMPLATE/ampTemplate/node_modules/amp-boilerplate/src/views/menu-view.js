var fs = require('fs');
var Backbone = require('backbone');
require('bootstrap/dist/js/bootstrap');
var _ = require('underscore');

var Template = fs.readFileSync(__dirname + '/../templates/menu-template.html', 'utf8');
var MenuCollection = require('../collections/amp-menus-collection.js');
var MenuModel = require('../models/amp-menus-model.js');

var SubmenuView = require('./submenu-compositeview.js');
var AboutView = require('./about-view.js');


module.exports = Backbone.View.extend({
  el: '#amp-header',
  appendEl: '#AmpMenus',
  template: _.template(Template),
  menuRendered : new $.Deferred(),
  events: {
    'click #show_login_pop': 'openLoginBox'
  },

  initialize: function(options) {
    this.collection = new MenuCollection();
    this.translator = options.translator;
    this.showLogin = options.showLogin;
    var self = this;
    this.collection.fetch().then(function() {self.render();});
    this.firstRender = true;
    this.about = new AboutView(options);
    _.bindAll(this, 'addOne', 'addAll','showAbout');

  },

  addAll: function() {
    this.collection.each(this.addOne);
    this.menuRendered.resolve();
  },

  addOne: function(model) {
    view = new SubmenuView({model: model});
    this.listenTo(view, 'showAbout', this.showAbout);
    var self = this;
    this.listenTo(view, 'switchLanguage', function(lng) {
      self.translator.setLanguage(lng.language).always(function() {
        location.reload();
      });
    });
    view.render();
    $(this.appendEl).append(view.el);
  },

  render: function() {
    var self = this;
    if (this.firstRender) {
      this.$el.html(this.template({showLogin:self.showLogin}));
      this.addAll();
      this.firstRender = false;
      //Ashamed still, I'm forced to this, because the form comes from `loginWidget3.js` and I'm too afraid to touch it
      $('#show_login_pop_box').insertBefore('#show_login_pop');
    }

    return this;
  },

  showAbout: function() {
    if ($('#about-popup').length == 0) {
      this.$el.parent().append(this.about.render().el);
    }
    if (typeof $().modal !== 'function') {
      $.noConflict();
    }
    $('#about-popup').modal({show: true, backdrop: false});
    this.translator.translateDOM($('#about-popup')[0]);
    return false;
  },

  openLoginBox: function(){
    $("div#show_login_pop_box").show();
    $("#j_username").focus();
  }
});

