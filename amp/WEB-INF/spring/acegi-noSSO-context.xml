<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<!--
- Acegi managed beans.
-->
<beans>

  <bean id="wicketApp" class="org.dgfoundation.amp.onepager.OnePagerApp">
    <property name="authenticationManager">
      <ref bean="authenticationManager" />
    </property>
  </bean>

  <bean id="digiUserDetailsService" class="org.digijava.kernel.security.auth.DigiUserDetailsService">
    <property name="populateGroupAuthorities">
	<value>false</value>
    </property>
  </bean>

  <bean id="daoAuthenticationProvider" class="org.digijava.kernel.security.auth.DigiDaoAuthenticationProvider">
    <property name="userDetailsService">
      <ref bean="digiUserDetailsService" />
    </property>
  </bean>

  <bean id="authenticationManager" class="org.springframework.security.providers.ProviderManager">
    <property name="providers">
      <list>
        <ref bean="daoAuthenticationProvider" />
      </list>
    </property>
  </bean>

  <bean id="roleVoter" class="org.springframework.security.vote.RoleVoter" />

  <bean id="accessDecisionManager" class="org.springframework.security.vote.UnanimousBased">
    <property name="decisionVoters">
      <list>
        <ref bean="roleVoter" />
      </list>
    </property>
  </bean>

<!--
  <bean id="securityInterceptor" class="org.springframework.security.intercept.web.FilterSecurityInterceptor">
    <property name="authenticationManager">
      <ref bean="authenticationManager" />
    </property>
    <property name="accessDecisionManager">
      <ref bean="accessDecisionManager" />
    </property>
    <property name="objectDefinitionSource">
      <value>
      CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISION
      PATTERN_TYPE_APACHE_ANT
      /faces/**=ROLE_EXPERT
      </value>
    </property>
  </bean>
-->

  <bean id="digiAuthenticationProcessingFilterEntryPoint" class="org.springframework.security.ui.webapp.AuthenticationProcessingFilterEntryPoint">
    <property name="loginFormUrl">
      <value>/showLayout.do?layout=login</value>
    </property>
  </bean>
  <!--
  <bean id="rememberMeServices" class="org.springframework.security.ui.rememberme.NullRememberMeServices" />
  -->
<!--
  <bean id="authenticationProcessingFilter" class="org.springframework.security.ui.webapp.AuthenticationProcessingFilter">
    <property name="filterProcessesUrl">
      <value>/j_spring_security_check</value>
    </property>
    <property name="authenticationFailureUrl">
      <value>/showLayout.do?layout=login</value>
    </property>
    <property name="defaultTargetUrl">
      <value>/showMyDesktop.do</value>
    </property>
    <property name="authenticationManager">
      <ref bean="authenticationManager" />
    </property>
  </bean>
-->
  <bean id="authenticationProcessingFilter" class="org.digijava.module.aim.auth.AmpAuthenticationProcessingFilter">
    <property name="filterProcessesUrl">
      <value>/j_spring_security_check</value>
    </property>
    <property name="authenticationFailureUrl">
      <value>/aim/getLoginStatus.do?loginError=invalidLogin</value>
    </property>
   <property name="exceptionMappings">
     <props>
       <prop key="org.digijava.module.aim.auth.InvalidUserException">/aim/getLoginStatus.do?loginError=invalidUser</prop>
       <prop key="org.digijava.module.aim.auth.NotTeamMemberException">/aim/getLoginStatus.do?loginError=noTeamMember</prop>
     </props>
    </property>
    <property name="defaultTargetUrl">
      <value>/aim/getLoginStatus.do?loginError=noError</value>
    </property>
    <property name="alwaysUseDefaultTargetUrl">
      <value>true</value>
    </property>
    <property name="authenticationManager">
      <ref bean="authenticationManager" />
    </property>
  </bean>

  <bean id="logoutFilter" class="org.springframework.security.ui.logout.LogoutFilter">
    <!-- URL redirected to after logout -->
    <constructor-arg value="/aim/logout.do"/> 
    <constructor-arg>
      <list>
        <bean class="org.springframework.security.ui.logout.SecurityContextLogoutHandler">
          <property name="invalidateHttpSession" value="false"/>
         </bean>
        <bean class="org.digijava.module.aim.auth.AmpLogoutHandler" />
      </list>
    </constructor-arg>
    <property name="filterProcessesUrl">
      <value>/j_spring_logout</value>
    </property>
</bean>

<bean id="filterChainProxy" class="org.springframework.security.util.FilterChainProxy">
  <property name="filterInvocationDefinitionSource">
    <value>
    CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISON
    PATTERN_TYPE_APACHE_ANT
    /**=httpSessionContextIntegrationFilter, logoutFilter, exceptionTranslationFilter, authenticationProcessingFilter
    </value>
  </property>
</bean>

<bean id="httpSessionContextIntegrationFilter" class="org.springframework.security.context.HttpSessionContextIntegrationFilter">
  <property name="allowSessionCreation"><value>true</value></property>
</bean>

<bean id="exceptionTranslationFilter" class="org.springframework.security.ui.ExceptionTranslationFilter">
  <property name="authenticationEntryPoint"><ref
    local="digiAuthenticationProcessingFilterEntryPoint"/></property>
    <property name="accessDeniedHandler">
      <bean class="org.springframework.security.ui.AccessDeniedHandlerImpl">
        <property name="errorPage">
           <value>/aim/getLoginStatus.do?loginError=noTeamMember</value>
        </property>
      </bean>
</property>
</bean>

</beans>
