<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	
	<jira>AMP-7703</jira>
	<author>dare</author>
	<description>
		1.drop amp_activity_id,activity_id Foreign Keys on amp_component_funding table
		2.remove unused column
	</description>
	
	<trigger type="all">
		<condition type="custom">
			<script returnVar="y">
              <lang type="mysql">SELECT count(C.`COLUMN_NAME`) FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_component_funding' and COLUMN_NAME='activity_id' and  TABLE_SCHEMA =(SELECT database())</lang>
          </script>
          <test>y.intValue()!=0</test>
		</condition>
	</trigger>
	
	
	<apply>
		<script>
			<lang type="mysql" delimiter="$">				
				DROP PROCEDURE IF EXISTS dropFKFromComponentFunding$ 
				CREATE PROCEDURE dropFKFromComponentFunding()  MODIFIES SQL DATA  
				BEGIN 
				
					DECLARE done INT DEFAULT 0;
					DECLARE a varchar(512);
					DECLARE cur1 CURSOR FOR select CONSTRAINT_NAME from information_schema.KEY_COLUMN_USAGE where TABLE_NAME ='amp_component_funding' and (COLUMN_NAME like'activity_id' or COLUMN_NAME like'amp_activity_id') and TABLE_SCHEMA =(SELECT database());
					DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
					OPEN cur1;
		
					REPEAT 
						FETCH cur1 INTO a; 
						IF NOT done THEN 
							SET @s = concat('alter table  amp_component_funding  DROP FOREIGN KEY  ',a,';');
							SET @t = concat('alter table  amp_component_funding  DROP KEY  ',a,';');
							prepare stmt from @s;
							execute stmt;
							DEALLOCATE prepare stmt;
							prepare stmt from @t;
							execute stmt;
							DEALLOCATE prepare stmt;
							END IF;
					UNTIL done END REPEAT;
					CLOSE cur1;
				
				END$ 
				call dropFKFromComponentFunding()$ 
				drop PROCEDURE dropFKFromComponentFunding$ 				
			</lang>			
		</script>
		<script>
			<lang type="mysql" delimiter=";">
				update  amp_component_funding set amp_activity_id=activity_id;
				alter  table amp_component_funding drop column activity_id;
			</lang>
		</script>
	</apply>
</tns:patch>
 