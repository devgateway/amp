<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	
	<jira>AMP-7624</jira>
	<author>dare</author>
	<description>
		drop unused columns from amp_activity_version table if they exist
	</description>
	
	<apply>
		<script>			
			<lang type="mysql" delimiter=";">
				drop temporary table if exists temp_odd_columns;
create temporary table temp_odd_columns(column_name varchar(255));

insert into temp_odd_columns SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='contact_name' and  TABLE_SCHEMA =(SELECT database());
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='cont_first_name' and  TABLE_SCHEMA =(SELECT database()));

insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='cont_last_name' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='email' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='dnr_cont_title' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='dnr_cont_organization' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='dnr_cont_phone_number' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns  (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='dnr_cont_fax_number' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns  (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='cnt_first_name' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns  (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='mofed_cnt_last_name' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns  (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='mofed_cnt_email' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns  (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='mfd_cont_title' and  TABLE_SCHEMA =(SELECT database()));
				
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='cont_organization' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='mfd_cont_phone_number' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='mfd_cont_fax_number' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='prj_co_first_name' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='prj_co_last_name' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='prj_co_email' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='prj_co_title' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='prj_co_organization' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='prj_co_phone_number' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='prj_co_fax_number' and  TABLE_SCHEMA =(SELECT database()));
				
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='sec_min_first_name' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='sec_min_last_name' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='sec_min_email' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='sec_min_title' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='sec_min_organization' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='sec_min_phone_number' and  TABLE_SCHEMA =(SELECT database()));
insert into temp_odd_columns (SELECT C.`COLUMN_NAME` FROM information_schema.`COLUMNS` C where TABLE_NAME ='amp_activity_version' and COLUMN_NAME='sec_min_fax_number' and  TABLE_SCHEMA =(SELECT database()));				
			</lang>
		</script>
		
		<script>
			<lang delimiter="$" type="mysql">
				DROP PROCEDURE IF EXISTS updateAmpActivityVersion$ 
CREATE PROCEDURE updateAmpActivityVersion()  MODIFIES SQL DATA 
 BEGIN 
				
DECLARE done INT DEFAULT 0;
DECLARE a varchar(512);
DECLARE cur1 CURSOR FOR select column_name from temp_odd_columns;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
OPEN cur1;
				
REPEAT 
FETCH cur1 INTO a; 
IF NOT done THEN 
SET @s = concat('alter table  amp_activity_version  DROP ',a,';');
prepare stmt from @s;
execute stmt;
DEALLOCATE prepare stmt;
END IF;
UNTIL done END REPEAT;
CLOSE cur1;
				
END$
call updateAmpActivityVersion()$ 
drop PROCEDURE updateAmpActivityVersion$ 
			</lang>
		</script>
		
		<script>
			<lang delimiter=";" type="mysql">
				drop temporary table if exists temp_odd_columns;
			</lang>
		</script>
	</apply>
</tns:patch>
 