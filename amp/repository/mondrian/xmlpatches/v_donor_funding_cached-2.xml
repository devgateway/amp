<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="false" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
  <jira>AMP-7528</jira>
  <keyword>Mondrian</keyword>
  <author>Diego Dimunzio</author>
  <description>Include Secondary sectors schema to mondrian cube and sub-sectors</description>
  <apply>
    <script>
    <lang delimiter=";" type="mysql">
    CREATE OR REPLACE VIEW `v_donor_funding_cached` AS
 	select `f`.`amp_activity_id` AS `amp_activity_id`,
         `f`.`amp_funding_id` AS `amp_funding_id`,
         `fd`.`amp_fund_detail_id` AS `amp_fund_detail_id`,
         `d`.`name` AS `donor_name`,
         `fd`.`transaction_type` AS `transaction_type`,
         `fd`.`adjustment_type` AS `adjustment_type`,
         `fd`.`transaction_date` AS `transaction_date`,
         ((((((((((`fd`.`transaction_amount` * coalesce(`rc`.`location_percentage`, 100)) / 100) *
         coalesce(`pp`.`program_percentage`, 100)) / 100) * coalesce(`sp`.`program_percentage`, 100
         )) / 100) * coalesce(`np`.`program_percentage`, 100)) / 100) * `sa`.`sector_percentage`) /
         100) AS `transaction_amount`,
         `c`.`currency_code` AS `currency_code`,
         `cval`.`id` AS `terms_assist_id`,
         `cval`.`category_value` AS `terms_assist_name`,
         `fd`.`fixed_exchange_rate` AS `fixed_exchange_rate`,
         `b`.`org_grp_name` AS `org_grp_name`,
         `ot`.`org_type` AS `donor_type_name`,
         `cval2`.`category_value` AS `financing_instrument_name`,
         `cval2`.`id` AS `financing_instrument_id`,
         `d`.`amp_org_id` AS `org_grp_id`,
         `ot`.`amp_org_type_id` AS `org_type_id`,
         `fd`.`disbursement_order_rejected` AS `disb_ord_rej`,
         `s`.`sectorname` AS `p_sectorname`,
         `getParentSectorId`(`s`.`amp_sector_id`) AS `amp_sector_id`,
         `sa`.`sector_percentage` AS `sector_percentage`,
         `s`.`sec_scheme_name` AS `p_amp_sec_scheme_name`,
         `sa`.`classification_config_id` AS `sec_act_id`,
         `rc`.`Region` AS `region`,
         `pp`.`name` AS `primary_program_name`,
         `pp`.`amp_program_id` AS `pp_id`,
         `ppl1`.`name` AS `ppl1_name`,
         `ppl2`.`name` AS `ppl2_name`,
         `ppl3`.`name` AS `ppl3_name`,
         `ppl4`.`name` AS `ppl4_name`,
         `ppl5`.`name` AS `ppl5_name`,
         `ppl6`.`name` AS `ppl6_name`,
         `ppl7`.`name` AS `ppl7_name`,
         `ppl8`.`name` AS `ppl8_name`,
         `sp`.`name` AS `secondary_program_name`,
         `spl1`.`name` AS `spl1_name`,
         `spl2`.`name` AS `spl2_name`,
         `spl3`.`name` AS `spl3_name`,
         `spl4`.`name` AS `spl4_name`,
         `spl5`.`name` AS `spl5_name`,
         `spl6`.`name` AS `spl6_name`,
         `spl7`.`name` AS `spl7_name`,
         `spl8`.`name` AS `spl8_name`,
         `sp`.`amp_program_id` AS `sp_id`,
         `np`.`name` AS `national_program_name`,
         `sp`.`amp_program_id` AS `np_id`,
         `psub`.`sectorname` AS `p_sub_sector_name`,
         `ssub`.`sectorname` AS `s_sub_sector_name`,
         `secs`.`sectorname` AS `s_sectorname`,
         `ss`.`sec_scheme_name` AS `s_amp_sec_scheme_name`
  from (((((((((((((((((((((((((((((((((`amp_funding` `f`
       join `amp_funding_detail` `fd` on ((`f`.`amp_funding_id` = `fd`.`amp_funding_id`)))
       join `amp_category_value` `cval` on ((`f`.`type_of_assistance_category_va` = `cval`.`id`)))
       join `amp_currency` `c` on ((`fd`.`amp_currency_id` = `c`.`amp_currency_id`)))
       left join `amp_organisation` `d` on ((`f`.`amp_donor_org_id` = `d`.`amp_org_id`)))
       join `amp_org_group` `b` on ((`d`.`org_grp_id` = `b`.`amp_org_grp_id`)))
       join `amp_org_type` `ot` on ((`b`.`org_type` = `ot`.`amp_org_type_id`)))
       join `amp_category_value` `cval2` on ((`f`.`financing_instr_category_value` = `cval2`.`id`))
       )
       join `amp_activity_sector` `sa` on ((`f`.`amp_activity_id` = `sa`.`amp_activity_id`)))
       join `cached_v_primary_sector` `s` on ((`getParentSectorId`(`sa`.`amp_sector_id`) =
       `s`.`amp_sector_id`)))
       left join `cached_v_sub_sector` `psub` on ((`sa`.`amp_activity_id` =
       `psub`.`amp_activity_id`)))
       left join `cached_v_regions` `rc` on ((`f`.`amp_activity_id` = `rc`.`amp_activity_id`)))
       left join `cached_v_primary_program` `pp` on ((`f`.`amp_activity_id` =
       `pp`.`amp_activity_id`)))
       left join `cached_v_primary_program_level_1` `ppl1` on ((`f`.`amp_activity_id` =
       `ppl1`.`amp_activity_id`)))
       left join `cached_v_primary_program_level_2` `ppl2` on ((`f`.`amp_activity_id` =
       `ppl2`.`amp_activity_id`)))
       left join `cached_v_primary_program_level_3` `ppl3` on ((`f`.`amp_activity_id` =
       `ppl3`.`amp_activity_id`)))
       left join `cached_v_primary_program_level_4` `ppl4` on ((`f`.`amp_activity_id` =
       `ppl4`.`amp_activity_id`)))
       left join `cached_v_primary_program_level_5` `ppl5` on ((`f`.`amp_activity_id` =
       `ppl5`.`amp_activity_id`)))
       left join `cached_v_primary_program_level_6` `ppl6` on ((`f`.`amp_activity_id` =
       `ppl6`.`amp_activity_id`)))
       left join `cached_v_primary_program_level_7` `ppl7` on ((`f`.`amp_activity_id` =
       `ppl7`.`amp_activity_id`)))
       left join `cached_v_primary_program_level_8` `ppl8` on ((`f`.`amp_activity_id` =
       `ppl8`.`amp_activity_id`)))
       left join `cached_v_secondary_program` `sp` on ((`f`.`amp_activity_id` =
       `sp`.`amp_activity_id`)))
       left join `cached_v_secondary_program_level_1` `spl1` on ((`f`.`amp_activity_id` =
       `spl1`.`amp_activity_id`)))
       left join `cached_v_secondary_program_level_2` `spl2` on ((`f`.`amp_activity_id` =
       `spl2`.`amp_activity_id`)))
       left join `cached_v_secondary_program_level_3` `spl3` on ((`f`.`amp_activity_id` =
       `spl3`.`amp_activity_id`)))
       left join `cached_v_secondary_program_level_4` `spl4` on ((`f`.`amp_activity_id` =
       `spl4`.`amp_activity_id`)))
       left join `cached_v_secondary_program_level_5` `spl5` on ((`f`.`amp_activity_id` =
       `spl5`.`amp_activity_id`)))
       left join `cached_v_secondary_program_level_6` `spl6` on ((`f`.`amp_activity_id` =
       `spl6`.`amp_activity_id`)))
       left join `cached_v_secondary_program_level_7` `spl7` on ((`f`.`amp_activity_id` =
       `spl7`.`amp_activity_id`)))
       left join `cached_v_secondary_program_level_8` `spl8` on ((`f`.`amp_activity_id` =
       `spl8`.`amp_activity_id`)))
       left join `cached_v_national_program` `np` on ((`f`.`amp_activity_id` =
       `np`.`amp_activity_id`)))
       left join `cached_v_secondary_sector` `secs` on ((`secs`.`amp_activity_id` =
       `sa`.`amp_activity_id`)))
       left join `cached_v_sec_sub_sector` `ssub` on ((`sa`.`amp_activity_id` =
       `ssub`.`amp_activity_id`)))
       left join `amp_sector_scheme` `ss` on ((`secs`.`amp_sector_scheme_id` =
       `ss`.`amp_sec_scheme_id`)))
  group by `fd`.`transaction_type`,
           `fd`.`amp_fund_detail_id`,
           `fd`.`disbursement_order_rejected`,
           `fd`.`adjustment_type`,
           `fd`.`transaction_amount`,
           `fd`.`transaction_date`,
           `f`.`amp_funding_id`,
           `f`.`amp_activity_id`,
           `getParentSectorId`(`s`.`amp_sector_id`),
           `s`.`amp_sector_id`,
           `sa`.`classification_config_id`,
           `sa`.`sector_percentage`,
           `sa`.`amp_activity_id`,
           `ot`.`org_type`,
           `ot`.`amp_org_type_id`,
           `d`.`amp_org_id`,
           `cval2`.`id`,
           `cval2`.`category_value`,
           `cval`.`category_value`,
           `cval`.`id`,
           `b`.`org_grp_name`,
           `fd`.`fixed_exchange_rate`,
           `c`.`currency_code`,
           `d`.`name`,
           `rc`.`region_id`,
           `pp`.`name`,
           `pp`.`amp_program_id`,
           `ppl2`.`name`,
           `ppl2`.`amp_program_id`,
           `ppl3`.`name`,
           `ppl3`.`amp_program_id`,
           `ppl4`.`name`,
           `ppl4`.`amp_program_id`,
           `ppl5`.`name`,
           `ppl5`.`amp_program_id`,
           `ppl6`.`name`,
           `ppl6`.`amp_program_id`,
           `ppl7`.`name`,
           `ppl7`.`amp_program_id`,
           `ppl8`.`name`,
           `ppl8`.`amp_program_id`,
           `sp`.`amp_program_id`,
           `sp`.`name`,
           `spl2`.`name`,
           `spl2`.`amp_program_id`,
           `spl3`.`name`,
           `spl3`.`amp_program_id`,
           `spl4`.`name`,
           `spl4`.`amp_program_id`,
           `spl5`.`name`,
           `spl5`.`amp_program_id`,
           `spl6`.`name`,
           `spl6`.`amp_program_id`,
           `spl7`.`name`,
           `spl7`.`amp_program_id`,
           `spl8`.`name`,
           `spl8`.`amp_program_id`,
           `np`.`amp_program_id`,
           `np`.`name`,
           `psub`.`sectorname`,
           `psub`.`amp_sector_id`
  order by `f`.`amp_activity_id`,
           `getSectorName`(`getParentSectorId`(`sa`.`amp_sector_id`)),
           `fd`.`transaction_type`,
           `f`.`amp_funding_id`;
	</lang>
    </script>
  </apply>
</tns:patch>
