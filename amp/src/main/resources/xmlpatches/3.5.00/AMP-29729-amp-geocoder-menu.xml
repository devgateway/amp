<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../../../schemas/xmlpatcher.xsd ">
	<jira>AMP-29729</jira>
	<author>vchihai</author>
	<description>Adding menu entry for AMP GeoCoder</description>
	<apply>
		<script>
			<lang delimiter=";" type="postgres"><![CDATA[

				INSERT INTO amp_modules_visibility (id, name, haslevel, parent)
				VALUES (nextval('amp_modules_visibility_seq'),
						'AutoGeocoder',
						TRUE,
						(SELECT id
						 FROM amp_modules_visibility
						 WHERE name = '/GIS' AND parent IS NULL));


				INSERT INTO amp_menu_entry(SELECT nextval('amp_menu_entry_seq'),
					(SELECT id FROM amp_menu_entry WHERE name='Tools' AND parent_id IS null), 'AutoGeocoder', 'AutoGeocoder', null, null, null,
					(SELECT max(m.position)+1 FROM amp_menu_entry m JOIN amp_menu_entry pm ON m.parent_id = pm.id WHERE pm.name = 'Tools' AND pm.parent_id IS NULL), null);

				INSERT INTO amp_visibility_rule(SELECT nextval('amp_visibility_rule_seq'), null, 1);

				INSERT INTO amp_visibility_rule_amp_modules_visibility(SELECT currval('amp_visibility_rule_seq'),
					(SELECT id FROM amp_modules_visibility WHERE name = 'AutoGeocoder' AND parent IN (SELECT id FROM amp_modules_visibility WHERE name = '/GIS')));

				INSERT INTO amp_menu_entry_view(select currval('amp_menu_entry_seq'),
					(SELECT currval('amp_visibility_rule_seq')), 2, '/TEMPLATE/reampv2/build/index.html#/geocoder');

			]]></lang>
		</script>
	</apply>
</tns:patch>