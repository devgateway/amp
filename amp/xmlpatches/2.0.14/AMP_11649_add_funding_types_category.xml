<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
  <jira>AMP-11649</jira>
  <keyword>Funding categories </keyword>
  <author>Armen Gharibyan</author>
  <description>Create the funding category</description>
  
  
  <trigger type="all">
		<condition type="custom">
			<script returnVar="cnt">
				<lang type="postgres">SELECT count(*) from amp_category_class where keyname='adjustment_type'</lang>
			</script>
			<test>cnt == 0</test>
		</condition>
	</trigger>
	
  <apply>
    <script>
      <lang delimiter=";" type="postgres">
    INSERT INTO amp_category_class(id, category_name, keyname, description, is_multiselect, is_ordered)
    values ( (select max(id)+1 from amp_category_class) , 'Adjustment Type' , 'adjustment_type', '', 'f', 'f');
    
   
    INSERT INTO amp_category_value(
            id, category_value, amp_category_class_id, index_column)
    VALUES ((select max(id)+1 from amp_category_value), 
            'Planned',
            (select id from amp_category_class where keyname='adjustment_type'), 0);

  INSERT INTO amp_category_value(
            id, category_value, amp_category_class_id, index_column)
    VALUES ((select max(id)+1 from amp_category_value), 
            'Actual',
            (select id from amp_category_class where keyname='adjustment_type'), 1);
  
    INSERT INTO amp_category_value(
            id, category_value, amp_category_class_id, index_column)
    VALUES ((select max(id)+1 from amp_category_value), 
            'Pipeline',
            (select id from amp_category_class where keyname='adjustment_type'), 2);
            
            
    UPDATE amp_funding_detail set adjustment_type = (SELECT id
    FROM amp_category_value   where amp_category_class_id = 
     (SELECT id from amp_category_class where keyname='adjustment_type') and index_column = 0)
  where adjustment_type = 0;        
            
        UPDATE amp_funding_detail set adjustment_type = (SELECT id
    FROM amp_category_value   where amp_category_class_id = 
     (SELECT id from amp_category_class where keyname='adjustment_type') and index_column = 1)
  where adjustment_type = 1;          
            
         UPDATE amp_funding_detail set adjustment_type = (SELECT id
    FROM amp_category_value   where amp_category_class_id = 
     (SELECT id from amp_category_class where keyname='adjustment_type') and index_column = 2)
  where adjustment_type = 2;           
            
        
            
   UPDATE amp_regional_funding set adjustment_type = (SELECT id
    FROM amp_category_value   where amp_category_class_id = 
     (SELECT id from amp_category_class where keyname='adjustment_type') and index_column = 0)
  where adjustment_type = 0;        
            
        UPDATE amp_regional_funding set adjustment_type = (SELECT id
    FROM amp_category_value   where amp_category_class_id = 
     (SELECT id from amp_category_class where keyname='adjustment_type') and index_column = 1)
  where adjustment_type = 1;          
            
         UPDATE amp_regional_funding set adjustment_type = (SELECT id
    FROM amp_category_value   where amp_category_class_id = 
     (SELECT id from amp_category_class where keyname='adjustment_type') and index_column = 2)
  where adjustment_type = 2;           
              
 
 
    UPDATE amp_component_funding set adjustment_type = (SELECT id
    FROM amp_category_value   where amp_category_class_id = 
     (SELECT id from amp_category_class where keyname='adjustment_type') and index_column = 0)
  where adjustment_type = 0;        
            
        UPDATE amp_component_funding set adjustment_type = (SELECT id
    FROM amp_category_value   where amp_category_class_id = 
     (SELECT id from amp_category_class where keyname='adjustment_type') and index_column = 1)
  where adjustment_type = 1;          
            
         UPDATE amp_component_funding set adjustment_type = (SELECT id
    FROM amp_category_value   where amp_category_class_id = 
     (SELECT id from amp_category_class where keyname='adjustment_type') and index_column = 2)
  where adjustment_type = 2;     
             
    	 </lang>
    </script>
  </apply>

</tns:patch>