<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-19550</jira>
	<keyword>translation</keyword>
	<author>jdeanquin</author>
	<description>Update dg_messages were we have specific translations per workspace prefix, specifically for SSC in Honduras.</description>
	<apply>
		<script>
			<lang type="bsh">
				import org.hibernate.SQLQuery;
				import org.hibernate.Criteria;
				import org.digijava.kernel.entity.Message;
				import org.hibernate.criterion.Restrictions;
				Criteria crit = session.createCriteria(Message.class);
				crit.add(Restrictions.like("key", "SSC_%"));
				countMessagesUpdated = 0;
				List msgs = crit.list();

				for (msg: msgs) {
				    m = msg.getKey().split("_");
				    if (msg.getOriginalMessage() != null &amp;&amp; msg.getOriginalMessage().trim().length() > 0) {
				        newKey = Integer.toString((m[0] + "_" + msg.getOriginalMessage()).trim().toLowerCase().hashCode());
				        
						critDuplicateKey = session.createCriteria(Message.class);
						critDuplicateKey.add(Restrictions.like("key", newKey));
						critDuplicateKey.add(Restrictions.like("locale", msg.getLocale()));
						critDuplicateKey.add(Restrictions.like("siteId", msg.getSiteId()));
				        listDuplicateKey = critDuplicateKey.list();
				        if (listDuplicateKey.size() > 0) {
				        
					        qry = "delete from dg_message where message_key='" + newKey;
					        qry += "' and lang_iso='" + msg.getLocale() + "' and site_id='" + msg.getSiteId() + "'";
						    	        
					        session.createSQLQuery(qry).executeUpdate();
				        } 
					    qry = "update dg_message set message_key='" + newKey + "',prefix='" + m[0] + "_";
					    qry += "' where message_key='" + msg.getKey();
					    qry += "' and lang_iso='" + msg.getLocale() + "' and site_id='" + msg.getSiteId() + "'";
					        
					    session.createSQLQuery(qry).executeUpdate();
					        
				        countMessagesUpdated++;
				    } else {
				        critOrig = session.createCriteria(Message.class);
				        critOrig.add(Restrictions.like("key", m[1]));
				        critOrig.add(Restrictions.isNotNull("originalMessage"));

				        list = critOrig.list();
				        if (list.size() > 0) {
				            orig = list.get(0);
				            if (orig.getOriginalMessage() != null &amp;&amp; orig.getOriginalMessage().trim().length() > 0) {
				                newKey = Integer.toString((m[0] + "_" + orig.getOriginalMessage()).trim().toLowerCase().hashCode());
				                
						        critDuplicateKey = session.createCriteria(Message.class);
						        critDuplicateKey.add(Restrictions.like("key", newKey));
						        critDuplicateKey.add(Restrictions.like("locale", msg.getLocale()));
						        critDuplicateKey.add(Restrictions.like("siteId", msg.getSiteId()));
				                listDuplicateKey = critDuplicateKey.list();
				        		if (listDuplicateKey.size() > 0) {
				        		
				                	qry = "delete from dg_message ";
				                	qry += " where message_key='" + newKey + "' ";
				                	qry += " and lang_iso='" + msg.getLocale() + "' and site_id='" + msg.getSiteId() + "'";
					    	              
					                session.createSQLQuery(qry).executeUpdate();
				    	        } 
				    	        
				                qry = "update dg_message set message_key='" + newKey + "',prefix='" + m[0] + "_";
				                qry += "' where message_key='" + msg.getKey();
				                qry += "' and lang_iso='" + msg.getLocale() + "' and site_id='" + msg.getSiteId() + "'";
					    	        
					            session.createSQLQuery(qry).executeUpdate();
					              					    	        				                
				                countMessagesUpdated++;
				            }
				        } else {
				            if (msg.getMessage() != null &amp;&amp; msg.getMessage().trim().length() > 0) {
				                newKey = Integer.toString((m[0] + "_" + msg.getMessage()).trim().toLowerCase().hashCode());
				                
								critDuplicateKey = session.createCriteria(Message.class);
								critDuplicateKey.add(Restrictions.like("key", newKey));
								critDuplicateKey.add(Restrictions.like("locale", msg.getLocale()));
								critDuplicateKey.add(Restrictions.like("siteId", msg.getSiteId()));
						        listDuplicateKey = critDuplicateKey.list();
						        if (listDuplicateKey.size() > 0) {
						        
							        qry = "delete from dg_message where message_key='" + newKey;
							        qry += "' and lang_iso='" + msg.getLocale() + "' and site_id='" + msg.getSiteId() + "'";
							        
							        session.createSQLQuery(qry).executeUpdate();
						        } 
					            qry = "update dg_message set message_key='" + newKey + "',prefix='" + m[0] + "_";
					            qry += "' where message_key='" + msg.getKey();
					            qry += "' and lang_iso='" + msg.getLocale() + "' and site_id='" + msg.getSiteId() + "'";
						    	        
					            session.createSQLQuery(qry).executeUpdate();				                

				                countMessagesUpdated++;
				            }
				        }
				    }
				}
				print(countMessagesUpdated + " Messages updated by patch AMP-19950.xml");
			</lang>
		</script>
	</apply>
</tns:patch>