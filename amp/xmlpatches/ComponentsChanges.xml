<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-5343</jira>
	<keyword>keyword</keyword>
	<author>Diego Dimunzio</author>
	<description>
  	</description>
   <apply>
		<script>
			<lang delimiter=";" type="mysql">
			UPDATE amp_category_class SET category_name = 'Components Type' WHERE category_name like 'Components_Type_Key';
			DELETE FROM amp_category_value WHERE amp_category_class_id =( SELECT id FROM amp_category_class WHERE category_name like 'Components Type');
			DELETE FROM amp_category_class WHERE category_name like 'Components Type';
		
    		INSERT INTO `amp_category_class`(category_name,is_ordered,keyName,is_multiselect) VALUES ('Components Type', 1, 'Components_Type_Key',0);
			INSERT INTO `amp_category_value` (`category_value`,`amp_category_class_id`,index_column)
			SELECT ct.`name`,cc.`id`,0 FROM `amp_component_type` ct,`amp_category_class` cc where cc.`keyName` = 'Components_Type_Key';
			</lang>
		</script>
		<script>
			<lang type="mysql" delimiter="$">	
				DROP PROCEDURE IF EXISTS dropFKFromComponents$
				CREATE PROCEDURE dropFKFromComponents()  MODIFIES SQL DATA
					BEGIN
					DECLARE done INT DEFAULT 0;
					DECLARE a varchar(512);
					DECLARE cur1 CURSOR FOR select CONSTRAINT_NAME from information_schema.KEY_COLUMN_USAGE where TABLE_NAME = 'amp_components' and COLUMN_NAME like'type' and REFERENCED_TABLE_NAME LIKE 'amp_component_type' and TABLE_SCHEMA = (SELECT database());
					DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
					OPEN cur1;
						REPEAT
						FETCH cur1 INTO a;
						IF NOT done THEN
							SET @t = concat('alter table  amp_components  DROP FOREIGN KEY  ',a,';');
							prepare stmt from @t;
							execute stmt;
							DEALLOCATE prepare stmt;
						END IF;
						UNTIL done END REPEAT;
					CLOSE cur1;
					END$
				call dropFKFromComponents$
				drop PROCEDURE dropFKFromComponents$ 
			</lang>
		</script>
		<script>
			<lang delimiter=";" type="mysql">
    		UPDATE `amp_components` co, `amp_category_value` cv SET co.`type` = cv.`id` where cv.`category_value` IN (Select name from `amp_component_type` ct where ct.`type_id` = co.`type`);
			</lang>
		</script>
	</apply>
</tns:patch>
