<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true"
           xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
    <jira>AMP-30885</jira>
    <keyword>menu</keyword>
    <author>bmokandu</author>
    <description>Add menu entry for Data Importer</description>
    <apply>
        <script>
            <lang delimiter=";" type="postgres">
                insert into amp_menu_entry (id,parent_id,name,title,url,position,flags) values
                (nextval('amp_menu_entry_seq'),(select id from amp_menu_entry where name='Tools'),'Data Importer','Data Importer',null,9,null);
                INSERT INTO amp_menu_entry_view(menu_id, view_type)
                VALUES ((SELECT id FROM amp_menu_entry WHERE name = 'Data Importer'), 2);
                INSERT INTO amp_visibility_rule(SELECT nextval('amp_visibility_rule_seq'), null, 1);
                UPDATE amp_menu_entry_view SET rule_id=(SELECT currval('amp_visibility_rule_seq')) WHERE menu_id= (SELECT id FROM amp_menu_entry WHERE name = 'Data Importer') AND view_type=2;


                INSERT INTO amp_features_visibility (id,name,haslevel,parent)
                SELECT (select nextval('amp_features_visibility_seq')),'Data Importer',true,
                (SELECT id FROM amp_modules_visibility WHERE name = 'Tools')
                WHERE
                NOT EXISTS (SELECT id from amp_features_visibility  WHERE name  = 'Data Importer');


                INSERT INTO amp_visibility_rule_amp_features_visibility(select currval('amp_visibility_rule_seq'),
                (SELECT id FROM amp_features_visibility WHERE name = 'Data Importer'
                AND parent IN (SELECT id FROM amp_modules_visibility WHERE name = 'Tools')));


                <!--                Import Data-->

                insert into amp_menu_entry (id,parent_id,name,title,url,position,flags) values
                (nextval('amp_menu_entry_seq'),(select id from amp_menu_entry where name='Data Importer'),'Import Data','Import Data','/aim/dataImporter.do',1,null);
                INSERT INTO amp_menu_entry_view(menu_id, view_type)
                VALUES ((SELECT id FROM amp_menu_entry WHERE name = 'Import Data'), 2);
                INSERT INTO amp_visibility_rule(SELECT nextval('amp_visibility_rule_seq'), null, 1);
                UPDATE amp_menu_entry_view SET rule_id=(SELECT currval('amp_visibility_rule_seq')) WHERE menu_id= (SELECT id FROM amp_menu_entry WHERE name = 'Import Data') AND view_type=2;



                <!--                Import Progress-->

                insert into amp_menu_entry (id,parent_id,name,title,url,position,flags) values
                (nextval('amp_menu_entry_seq'),(select id from amp_menu_entry where name='Data Importer'),'View Progress','View Progress','/aim/viewImportProgress.do',2,null);
                INSERT INTO amp_menu_entry_view(menu_id, view_type)
                VALUES ((SELECT id FROM amp_menu_entry WHERE name = 'View Progress'), 2);
                INSERT INTO amp_visibility_rule(SELECT nextval('amp_visibility_rule_seq'), null, 1);
                UPDATE amp_menu_entry_view SET rule_id=(SELECT currval('amp_visibility_rule_seq')) WHERE menu_id= (SELECT id FROM amp_menu_entry WHERE name = 'View Progress') AND view_type=2;


            </lang>
        </script>
    </apply>
</tns:patch>
