<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="false" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-14167</jira>
	<keyword>Views</keyword>
	<author>Alexandru Artimon</author>
	<description>recreate view, this will always be the last version of the view</description>
	<trigger type="all">
		<condition type="custom">
			<script returnVar="val">
				<lang type="sql">
					SELECT settingsvalue FROM amp_global_settings where settingsname='Recreate the views on the next server restart';
				</lang>
			</script>
 			<test>val.equalsIgnoreCase("true")</test>
		</condition>
	</trigger> 
	<apply>
		<script>
			<lang delimiter=";" type="postgres">
				CREATE OR REPLACE VIEW v_primaryprogram_level_5 AS
			    	SELECT v_primaryprogram_all_level.amp_activity_id, 
			    		CASE 5
			    			WHEN v_primaryprogram_all_level.l1 THEN v_primaryprogram_all_level.n1
			    			WHEN v_primaryprogram_all_level.l2 THEN v_primaryprogram_all_level.n2
			    			WHEN v_primaryprogram_all_level.l3 THEN v_primaryprogram_all_level.n3
			    			WHEN v_primaryprogram_all_level.l4 THEN v_primaryprogram_all_level.n4
			    			WHEN v_primaryprogram_all_level.l5 THEN v_primaryprogram_all_level.n5
			    			WHEN v_primaryprogram_all_level.l6 THEN v_primaryprogram_all_level.n6
			    			WHEN v_primaryprogram_all_level.l7 THEN v_primaryprogram_all_level.n7
			    			WHEN v_primaryprogram_all_level.l8 THEN v_primaryprogram_all_level.n8
			    			ELSE NULL::character varying END AS name,
			    		CASE 5
			    			WHEN v_primaryprogram_all_level.l1 THEN v_primaryprogram_all_level.amp_program_id1
			    			WHEN v_primaryprogram_all_level.l2 THEN v_primaryprogram_all_level.amp_program_id2
			    			WHEN v_primaryprogram_all_level.l3 THEN v_primaryprogram_all_level.amp_program_id3
			    			WHEN v_primaryprogram_all_level.l4 THEN v_primaryprogram_all_level.amp_program_id4
			    			WHEN v_primaryprogram_all_level.l5 THEN v_primaryprogram_all_level.amp_program_id5
			    			WHEN v_primaryprogram_all_level.l6 THEN v_primaryprogram_all_level.amp_program_id6
			    			WHEN v_primaryprogram_all_level.l7 THEN v_primaryprogram_all_level.amp_program_id7
			    			WHEN v_primaryprogram_all_level.l8 THEN v_primaryprogram_all_level.amp_program_id8
			    			ELSE NULL::bigint END AS amp_program_id, 
			    		sum(v_primaryprogram_all_level.program_percentage) AS program_percentage
			    	FROM v_primaryprogram_all_level WHERE
			    		(CASE 5
			    			WHEN v_primaryprogram_all_level.l1 THEN v_primaryprogram_all_level.n1
			    			WHEN v_primaryprogram_all_level.l2 THEN v_primaryprogram_all_level.n2
			    			WHEN v_primaryprogram_all_level.l3 THEN v_primaryprogram_all_level.n3
			    			WHEN v_primaryprogram_all_level.l4 THEN v_primaryprogram_all_level.n4
			    			WHEN v_primaryprogram_all_level.l5 THEN v_primaryprogram_all_level.n5
			    			WHEN v_primaryprogram_all_level.l6 THEN v_primaryprogram_all_level.n6
			    			WHEN v_primaryprogram_all_level.l7 THEN v_primaryprogram_all_level.n7
			    			WHEN v_primaryprogram_all_level.l8 THEN v_primaryprogram_all_level.n8
			    		ELSE NULL::character varying END IS NOT NULL)
			    			GROUP BY v_primaryprogram_all_level.amp_activity_id,
			    				CASE 5 WHEN v_primaryprogram_all_level.l1 THEN v_primaryprogram_all_level.n1
			    				WHEN v_primaryprogram_all_level.l2 THEN v_primaryprogram_all_level.n2
			    				WHEN v_primaryprogram_all_level.l3 THEN v_primaryprogram_all_level.n3
			    				WHEN v_primaryprogram_all_level.l4 THEN v_primaryprogram_all_level.n4
			    				WHEN v_primaryprogram_all_level.l5 THEN v_primaryprogram_all_level.n5
			    				WHEN v_primaryprogram_all_level.l6 THEN v_primaryprogram_all_level.n6
			    				WHEN v_primaryprogram_all_level.l7 THEN v_primaryprogram_all_level.n7
			    				WHEN v_primaryprogram_all_level.l8 THEN v_primaryprogram_all_level.n8
			    			ELSE NULL::character varying END, 
			    				CASE 5 
			    					WHEN v_primaryprogram_all_level.l1 THEN v_primaryprogram_all_level.amp_program_id1
			    					WHEN v_primaryprogram_all_level.l2 THEN v_primaryprogram_all_level.amp_program_id2
			    					WHEN v_primaryprogram_all_level.l3 THEN v_primaryprogram_all_level.amp_program_id3
			    					WHEN v_primaryprogram_all_level.l4 THEN v_primaryprogram_all_level.amp_program_id4
			    					WHEN v_primaryprogram_all_level.l5 THEN v_primaryprogram_all_level.amp_program_id5
			    					WHEN v_primaryprogram_all_level.l6 THEN v_primaryprogram_all_level.amp_program_id6
			    					WHEN v_primaryprogram_all_level.l7 THEN v_primaryprogram_all_level.amp_program_id7
			    					WHEN v_primaryprogram_all_level.l8 THEN v_primaryprogram_all_level.amp_program_id8
			    					ELSE NULL::bigint END;;;
 			</lang>
		</script>
	</apply>
</tns:patch>
