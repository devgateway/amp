<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
    <jira>AMP-7517</jira>
    <keyword>contacts</keyword>
    <keyword>organizations</keyword>
    <author>Medea Gugushvili</author>
    <description>Migrate old contact data and remove old contact fields from organization.</description>
    
    <trigger type="all">
        <condition type="custom">
            <script returnVar="name">
                <lang type="mysql">Select count(*) from information_schema.COLUMNS c where  c.TABLE_NAME="amp_organisation" and c.TABLE_SCHEMA=database() and COLUMN_NAME like "contact_person_name"</lang>
            </script>
            <test>name.intValue()==1</test>
        </condition>
         <condition type="custom">
            <script returnVar="title">
                <lang type="mysql">Select count(*)  from information_schema.COLUMNS c where  c.TABLE_NAME="amp_organisation" and c.TABLE_SCHEMA=database() and COLUMN_NAME like "contact_person_title"</lang>
            </script>
            <test>title.intValue()==1</test>
        </condition>
         <condition type="custom">
            <script returnVar="email">
                <lang type="mysql">Select count(*)  from information_schema.COLUMNS c where  c.TABLE_NAME="amp_organisation" and c.TABLE_SCHEMA=database() and COLUMN_NAME like "email"</lang>
            </script>
            <test>email.intValue()==1</test>
        </condition>
         <condition type="custom">
            <script returnVar="phone">
                <lang type="mysql">Select count(*) from information_schema.COLUMNS c where  c.TABLE_NAME="amp_organisation" and c.TABLE_SCHEMA=database() and COLUMN_NAME like "phone"</lang>
            </script>
            <test>phone.intValue()==1</test>
        </condition>
         <condition type="custom">
            <script returnVar="fax">
                <lang type="mysql">Select count(*) from information_schema.COLUMNS c where  c.TABLE_NAME="amp_organisation" and c.TABLE_SCHEMA=database() and COLUMN_NAME like "fax"</lang>
            </script>
            <test>fax.intValue()==1</test>
        </condition>
    </trigger>


    <apply>
        <script>
          <lang delimiter=";" type="mysql">
                ALTER TABLE AMP_CONTACT ADD COLUMN tmp_org_id  bigint(20);

                insert into amp_contact (name,lastname,tmp_org_id)
                select  contact_person_name,'',amp_org_id
                from amp_organisation
                where
                (contact_person_name  is not null and contact_person_name!='') or
                (email is not null and email !='' ) or
                (phone is not null and phone!='') or
                (fax is not null and fax !='' );

                Insert into amp_org_contacts(contact_id,amp_org_id)
                select contact_Id,tmp_org_id from AMP_CONTACT
                where tmp_org_id is not NULL;

                INSERT INTO amp_contact_properties (name,value,contact_id)
                select 'contact email',org.email, c.contact_id from amp_contact c
                inner join amp_organisation org on c.tmp_org_id=org.amp_org_id
                where email is not null and email !='' ;

                INSERT INTO amp_contact_properties (name,value,contact_id)
                select 'contact phone',org.phone, c.contact_id from amp_contact c
                inner join amp_organisation org on c.tmp_org_id=org.amp_org_id
                where org.phone is not null and org.phone !='' ;


                INSERT INTO amp_contact_properties (name,value,contact_id)
                select 'contact fax',org.fax, c.contact_id from amp_contact c
                inner join amp_organisation org on c.tmp_org_id=org.amp_org_id
                where org.fax is not null and org.fax !='' ;

                ALTER TABLE AMP_CONTACT DROP COLUMN tmp_org_id;
                ALTER TABLE AMP_ORGANISATION DROP COLUMN contact_person_name;
                ALTER TABLE AMP_ORGANISATION DROP COLUMN contact_person_title;
                ALTER TABLE AMP_ORGANISATION DROP COLUMN email;
                ALTER TABLE AMP_ORGANISATION DROP COLUMN phone;
                ALTER TABLE AMP_ORGANISATION DROP COLUMN fax;
            </lang>
        </script>
    </apply>
</tns:patch>
