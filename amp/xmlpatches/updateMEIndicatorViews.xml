<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="false" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
    <jira>AMP-7526</jira>
    <keyword>indicators</keyword>
    <author>Medea Gugushvili</author>
    <description>Rewrite old views that used old tables (really weirdo views â€¦ why are they using "name" as column name everywhere...).</description>
    <apply>
        <script>
            <lang delimiter=";" type="mysql">
                CREATE OR REPLACE VIEW `v_indicator_actualvalue` AS
                select `con`.`activity_id` AS `amp_activity_id`,`val`.`value` AS `name`,`ind`.`indicator_id` AS `amp_me_indicator_id` from ((`amp_indicator_connection` `con` join `amp_indicator` `ind` ) join `amp_indicator_values` `val`)
                where `ind`.`indicator_id` = `con`.`indicator_id` and `val`.`ind_connect_id` =`con`.`id` and `val`.`value_type`=1 and `con`.`sub_clazz`='a' ;

                CREATE OR REPLACE VIEW `v_indicator_basevalue` AS
                select `con`.`activity_id` AS `amp_activity_id`,`val`.`value` AS `name`,`ind`.`indicator_id` AS `amp_me_indicator_id` from ((`amp_indicator_connection` `con` join `amp_indicator` `ind` ) join `amp_indicator_values` `val`)
                where `ind`.`indicator_id` = `con`.`indicator_id` and `val`.`ind_connect_id` =`con`.`id` and `val`.`value_type`=2 and `con`.`sub_clazz`='a' ;

                CREATE OR REPLACE VIEW `v_indicator_targetvalue` AS
                select `con`.`activity_id` AS `amp_activity_id`,`val`.`value` AS `name`,`ind`.`indicator_id` AS `amp_me_indicator_id` from ((`amp_indicator_connection` `con` join `amp_indicator` `ind` ) join `amp_indicator_values` `val`)
                where `ind`.`indicator_id` = `con`.`indicator_id` and `val`.`ind_connect_id` =`con`.`id` and `val`.`value_type`=0 and `con`.`sub_clazz`='a' ;

                CREATE OR REPLACE VIEW `v_indicator_name` AS
                select `con`.`activity_id` AS `amp_activity_id`,`ind`.`name` AS `name`,`ind`.`indicator_id` AS `amp_me_indicator_id` from (`amp_indicator_connection` `con` join `amp_indicator` `ind` )
                where `ind`.`indicator_id` = `con`.`indicator_id` and `con`.`sub_clazz`='a' ;

                CREATE OR REPLACE VIEW `v_indicator_description` AS
                select `con`.`activity_id` AS `amp_activity_id`,`ind`.`description` AS `name`,`ind`.`indicator_id` AS `amp_me_indicator_id` from (`amp_indicator_connection` `con` join `amp_indicator` `ind` )
                where `ind`.`indicator_id` = `con`.`indicator_id` and `con`.`sub_clazz`='a'  and  `ind`.`description`<> _utf8'';

                CREATE OR REPLACE VIEW `v_indicator_id` AS
                select `con`.`activity_id` AS `amp_activity_id`,`ind`.`code` AS `name`,`ind`.`indicator_id` AS `amp_me_indicator_id` from (`amp_indicator_connection` `con` join `amp_indicator` `ind` )
                where `ind`.`indicator_id` = `con`.`indicator_id` and `con`.`sub_clazz`='a'  ;
            </lang>
        </script>
    </apply>

</tns:patch>
